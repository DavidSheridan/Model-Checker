<!doctype html>
<html>
<head>
  <title>automata-parser</title>

  <script src="../../../../bower_components/webcomponentsjs/webcomponents.js"></script>
  <script src="../../../../bower_components/web-component-tester/browser.js"></script>
  <script src="../../../../bower_components/test-fixture/test-fixture-mocha.js"></script>

  <link rel="import" href="../../../../bower_components/polymer/polymer.html">
  <link rel="import" href="../../../../bower_components/promise-polyfill/promise-polyfill-lite.html">
  <link rel="import" href="../../../../bower_components/test-fixture/test-fixture.html">

  <link rel="import" href="../automata-parser.html">
</head>
<body>
  <test-fixture id="parser">
    <template>
      <automata-parser></automata-parser>
    </template>
  </test-fixture>

  <script>
    suite('<automata-parser>', function () {
      var parser;

      setup(function() {
        parser = fixture('parser');
      });

      var doTest = function(result, exp){
        assert.equal(result.length, exp.length, "The number of variables in the results does not match the number in the expected.");

        for(var i = 0; i < result.length; i++){
          assert.equal(result[i].label, exp[i].label, "Labels are not equivalent");
          assert.equal(result[i].id, exp[i].id, "ids are not equivalent");

          assert.equal(result[i].nodes.length, exp[i].nodes.length, "Nodes Lengths are not equal");
          for(var j =0; j < result[i].nodes.length; j++){
            assert.equal(result[i].nodes[j].label, exp[i].nodes[j].label, "Node labels at index "+j+" not equal");
          }

          assert.equal(result[i].edges.length, exp[i].edges.length, "Edges Lengths are not equal");
          for(var j =0; j < result[i].edges.length; j++){
            assert.equal(result[i].edges[j].label, exp[i].edges[j].label, "Edge label at index "+j+" not equal");
            assert.strictEqual(result[i].edges[j].from, parseInt(result[i].edges[j].from), "Edge from at index "+j+" must be an integer");
            assert.strictEqual(result[i].edges[j].to, parseInt(result[i].edges[j].to), "Edge to at index "+j+" must be an integer");
          }
        }
      };

      suite('Single Operator', function() {
        suite('Sequences', function() {
          test('Simple Sequence', function(){
            parser.code = 'test = a->b.';
            var result = parser.parse();

            var exp = [
              {
                label: 'test',
                nodes: [
                  {id: 0, label: '0'}, {id: 1, label:'1'}, {id: 2, label: '2'}
                ],
                edges: [
                  { from: 0, to: 1, label: 'a' },
                  { from: 1, to: 2, label: 'b' }
                ]
              }
            ];
            doTest(result, exp);
          });

          test('Simple Sequence with muli-character labels and whitespace', function(){
            parser.code = 'test = asc -> bsdd.';
            var result = parser.parse();

            var exp = [
              {
                label: 'test',
                nodes: [
                  {id: 0, label: '0'}, {id: 1, label:'1'}, {id: 2, label: '2'}
                ],
                edges: [
                  { from: 0, to: 1, label: 'asc' },
                  { from: 1, to: 2, label: 'bsdd' }
                ]
              }
            ];
            doTest(result, exp);
          });

          test('Multiple Sequences', function(){
            parser.code = 'test = a->b->c.';
            var result = parser.parse();

            var exp = [
              {
                label: 'test',
                nodes: [
                  {id: 0, label: '0'}, {id: 1, label:'1'}, {id: 2, label: '2'}, {id: 3, label: '3'}
                ],
                edges: [
                  { from: 0, to: 1, label: 'a' },
                  { from: 1, to: 2, label: 'b' },
                  { from: 2, to: 3, label: 'c' }
                ]
              }
            ];
            doTest(result, exp);
          });
        });

        suite('Or', function() {
          test('Simple OR', function(){
            parser.code = 'test=a|b.';
            var result = parser.parse();

            var exp = [
              {
                label: 'test',
                nodes: [
                  {id: 0, label: '0'}, {id: 1,label:'1'}
                ],
                edges: [
                  { from: 0, to: 1, label: 'a' },
                  { from: 0, to: 1, label: 'b' }
                ]
              }
            ];
            doTest(result, exp);
          });

          test('Multi-OR', function(){
            parser.code = 'test = a|b|c.';
            var result = parser.parse();

            var exp = [
              {
                label: 'test',
                nodes: [
                  {id: 0,label: '0'}, {id: 1,label:'1'}
                ],
                edges: [
                  { from: 0, to: 1, label: 'a' },
                  { from: 0, to: 1, label: 'b' },
                  { from: 0, to: 1, label: 'c' }
                ]
              }
            ];
            doTest(result, exp);
          });

          test('Multi-OR with whitespace', function(){
            parser.code = 'test = a    | b| c |d. foo = x|y.';
            var result = parser.parse();

            var exp = [
              {
                label: 'test',
                nodes: [
                  {id: 0,label: '0'}, {id: 1,label:'1'}
                ],
                edges: [
                  { from: 0, to: 1, label: 'a' },
                  { from: 0, to: 1, label: 'b' },
                  { from: 0, to: 1, label: 'c' },
                  { from: 0, to: 1, label: 'd' }
                ]
              },
              {
                label: 'foo',
                nodes: [
                  {id: 0 ,label: '0'}, {id: 1,label:'1'}
                ],
                edges: [
                  { from: 0, to: 1, label: 'x' },
                  { from: 0, to: 1, label: 'y' }
                ]
              }
            ];
            doTest(result, exp);
          });
        });

        suite('Optionals', function() {
          test('Simple optional', function(){

            parser.code = 'test = a?.';
            var result = parser.parse();

            var exp = [
              {
                label: 'test',
                nodes: [
                  {id: 0, label: '0'}, {id: 1,label:'1'}
                ],
                edges: [
                  { from: 0, to: 1, label: 'a' },
                  { from: 0, to: 1 }
                ]
              }
            ];
            doTest(result, exp);
          });
        });
      });


      suite('Multiple Operators', function() {
        test('sequence and or', function(){

          parser.code = 'test = a|b->c. foo = a->b|c.';
          var result = parser.parse();

          var exp = [
            {
              label: 'test',
              nodes: [
                {id: 0,label: '0'}, {id: 1,label:'1'}, {id: 2,label:'2'}
              ],
              edges: [
                { from: 0, to: 1, label: 'a' },
                { from: 0, to: 1, label: 'b' },
                { from: 1, to: 2, label: 'c' }
              ]
            },
            {
              label: 'foo',
              nodes: [
                {id: 0 ,label: '0'}, {id: 1,label:'1'}, {id: 2,label:'2'}
              ],
              edges: [
                { from: 0, to: 1, label: 'a' },
                { from: 1, to: 2, label: 'b' },
                { from: 1, to: 2, label: 'c' }

              ]
            }
          ];
          doTest(result, exp);
        });

        test('Or, Sequence and Optional, all in different orders.', function(){

          parser.code = 'test = a->b|c?. Testt = a|b->c?. Testtt = a?->b|c. Testttt = a?|b->c.';
          var result = parser.parse();

          var exp = [
            {
              label: 'test',
              nodes: [
                {id: 0, label: '0'}, {id: 1,label:'1'}, {id: 2, label: '2'}
              ],
              edges: [
                { from: 0, to: 1, label: 'a' },
                { from: 1, to: 2, label: 'b' },
                { from: 1, to: 2, label: 'c' },
                { from: 1, to: 2 }
              ]
            },
            {
              label: 'Testt',
              nodes: [
                {id: 0, label: '0'}, {id: 1,label:'1'}, {id: 2, label: '2'}
              ],
              edges: [
                { from: 0, to: 1, label: 'a' },
                { from: 1, to: 2, label: 'b' },
                { from: 1, to: 2, label: 'c' },
                { from: 1, to: 2 }
              ]
            },
            {
              label: 'Testtt',
              nodes: [
                {id: 0, label: '0'}, {id: 1,label:'1'}, {id: 2, label: '2'}
              ],
              edges: [
                { from: 0, to: 1, label: 'a' },
                { from: 0, to: 1 },
                { from: 1, to: 2, label: 'b' },
                { from: 1, to: 2, label: 'c' }

              ]
            },
            {
              label: 'Testttt',
              nodes: [
                {id: 0, label: '0'}, {id: 1,label:'1'}, {id: 2, label: '2'}
              ],
              edges: [
                { from: 0, to: 1, label: 'a' },
                { from: 0, to: 1 },
                { from: 0, to: 1, label: 'b' },
                { from: 1, to: 2, label: 'c' }
              ]
            }
          ];
          doTest(result, exp);
        });

        suite('Other', function() {
          test('Multiple Variables', function(){
            parser.code = 'test = a->b. hello = c->d.';
            var result = parser.parse();

            var exp = [
              {
                label: 'test',
                nodes: [
                  {id: 0, label: '0'}, {id: 1, label:'1'}, {id: 2, label: '2'}
                ],
                edges: [
                  { from: 0, to: 1, label: 'a' },
                  { from: 1, to: 2, label: 'b' }
                ]
              },
              {
                label: 'hello',
                nodes: [
                  {id: 0, label: '0'}, {id: 1, label:'1'}, {id: 2, label: '2'}
                ],
                edges: [
                  { from: 0, to: 1, label: 'c' },
                  { from: 1, to: 2, label: 'd' }
                ]
              }
            ];
            doTest(result, exp);
          });
        });
      });
    });
  </script>

</body>
</html>
