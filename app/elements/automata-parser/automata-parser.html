<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="parser.html">
<link rel="import" href="parseTreeInterpreter.html">
<link rel="import" href="../imports/graph.html">
<link rel="import" href="../imports/index-iterator.html">
<link rel="import" href="../imports/expression-interpreter.html">
<link rel="import" href="../imports/automaton.html">

<script>
// jshint -W098
(function() {
  Polymer({
    is: 'automata-parser',
    properties: {
      /**
       * The PEGjs parser.
       * Used to create a parse tree that we can the interpret.
       *
       * @private
       */
      _parser: {
        type: Object,
        value: PEG.automataParser, // created in parser.js
        readOnly: true
      }
    },

    /**
     * Parse the code and return the automata it defines.
     *
     * @param {!string} code - The code to parse
     * @param {!boolean} isFair - Determines whether fair or unfair abstraction is performed
     * @returns {!Automaton[]} Automata
     */
    parse: function(code) {
      var pt = this._parser.parse(code);
      var definitionsMap = interpretParseTree(pt);
      return this._buildParsingResults(definitionsMap);
    },

    /**
     * Builds an object containing the results of the parsing. This includes taking 
     * all the automaton definitions that are defined as visible and construct an 
     * array of automata, as well as taking all the operations parsed and constructing
     * an array of the outcomes.
     *
     * @private
     * @returns {!Automaton[]} Automata
     */
    _buildParsingResults: function(definitionsMap) {
      var automata = [];
      var operations = {operations: [], positions: []};
      if(true){
        // build automata array
        for (var key in definitionsMap){
          // only display automata which are defined as visible
          if(definitionsMap[key].isVisible){
            automata.unshift(new Automaton(key, definitionsMap[key].graph));
          }
        }

        // if there are no operations do not print the total numbe of operations
        if(operations.operations.length > 0){
          var results = 'Total Operations: ' + (pass + fail) +' (Pass: ' + pass + ', Fail: ' + fail + ')';
          operations.operations.unshift(results);
        }
      }
      return {automata: automata, operations: operations};
    }
  });
})();
</script>