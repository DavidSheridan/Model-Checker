<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../imports/ace.html">

<dom-module id="text-editor">
  <style>
    :host {
      display: block;
    }
    #editor{
      box-sizing: border-box;
      width: 100%;
      height: 100%;
    }
  </style>
  <template>
    <div id="editor"></div>
  </template>
</dom-module>
<script>
  (function() {
    Polymer({
      is: 'text-editor',

      properties: {
        /**
         * If true the editor will be brought into focus automatically when the elements is added to the dom
         * @default false
         */
        autofocus: {
          type: Boolean,
          value: false
        },

        /**
         * The amount of time for a text-editor-change event to fire after the content changes.
         * @default 1000
         */
        changeDebounceTime: {
          type: Number,
          value: 1000,
          notify: true
        },

        /**
         * Previous time field required to ensure timeout remains consistent.
         */
        _previousTime: {
          type: Number,
          value: 0
        },

        /**
         * the text editor
         */
        _editor: {
          type: Object,
          value: function(){
            var editor = ace.edit(this.$.editor);
            editor.setTheme('ace/theme/github');
            editor.getSession().setMode('ace/mode/plain_text'); // syntax highlighting
            return editor;
          }
        }
      },

      /**
       * Get the code the user has provided
       * @return {string} The code
       */
      getCode: function(){
        return this._editor.getValue();
      },

      /**
       * Set the code
       * @param {string} code The code
       */
      setCode: function(code){
        this._editor.setValue(code, 0);
      },

      focus: function(){
        this._editor.focus();
      },

      ready: function(){
        if(this.autofocus){
          this._editor.focus();
        }

        this._editor.on('change', function(e){
          var d = new Date();
          this._previousTime = d.getTime();
          setTimeout(function(){
            var d = new Date();
            if(d.getTime()-this._previousTime>=this.changeDebounceTime){
              this.fire('text-editor-change');
            }
          }.bind(this), this.changeDebounceTime);
        }.bind(this));
      }
    });
  })();
</script>
