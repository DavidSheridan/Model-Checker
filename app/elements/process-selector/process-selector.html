<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<dom-module id="process-selector">
  <style>
    :host {
      display: block;
    }
    paper-dropdown-menu{
      --paper-dropdown-menu: {
        width: var(--dropdown-menu-width, 200px);
      };
    }
    paper-dropdown-menu .dropdown-content{
      --paper-menu: {
        width: var(--dropdown-menu-width, 200px);
      };
    }
    paper-item.automaton:hover{
      background: var(--primary-background-color);
    }
  </style>
  <template>
    <div style="width:50%;float:left">
      <span>Rendered Process List</span>
      <br/>
      <paper-dropdown-menu id="process-display-selector" label="Process" on-iron-select="_onProcessSelection" disabled$="{{!_hasNames}}">
        <paper-menu class="dropdown-content">
          <template is="dom-repeat" items="{{display}}">
            <paper-item data-automaton-name="{{item.id}}">{{item.id}}</paper-item>
          </template>
          <paper-listbox class="dropdown-content" selected$="{{_initialSelection}}"></paper-listbox>
        </paper-menu>
      </paper-dropdown-menu>
      <paper-button onclick="toggleExplode()" disabled$="{{_explosionValid(locked,_hasSelection)}}">{{_explosionLabel}}</paper-button>
      <paper-button onclick="removeProcess()" disabled$="{{_combineWithLocked(locked,_hasSelection)}}">Remove Process</paper-button>
      <paper-button onclick="clearProcess()" disabled$="{{_combineWithLocked(locked,_hasNames)}}">Clear</paper-button>
    </div>
    <div style="">
      <span>Editor Process List</span>
      <br/>
      <paper-dropdown-menu id="process-name-selector" label="Process" on-iron-select="_onNameSelection" disabled$="{{!_hasProcesses}}">
        <paper-menu class="dropdown-content">
          <template is="dom-repeat" items="{{processes}}">
            <paper-item data-automaton-name="{{item.id}}">{{item.id}}</paper-item>
          </template>
          <paper-listbox class="dropdown-content" selected$="{{!_hasNameSelection}}"></paper-listbox>
        </paper-menu>
      </paper-dropdown-menu>
      <paper-checkbox checked="{{hideInterrupts}}" class="chbx middle" title="Hide interrupted processes behind a box">
        <span hidden$="{{smallScreen}}">Hide interrupts</span>
      </paper-checkbox>
      <paper-button onclick="addProcess()" disabled$="{{_combineWithLocked(locked,_hasNameSelection)}}">Add Process</paper-button>
      <paper-button onclick="addAll()" disabled$="{{_combineWithLocked(locked,_hasProcesses)}}">Add all processes</paper-button>
    </div>

  </template>

</dom-module>
<script>
  function toggleExplode() {
    let lbl = app.$.selector._explosionLabel;
    app.$.selector._explosionLabel = lbl==="Show all"?"Explode to process":"Show all";
    app.$.selector.fire('explode', lbl==="Explode to process");
  }
  function addProcess() {
    app.$.selector.fire('addProcess', "");
  }
  function removeProcess() {
    app.$.selector.fire('removeProcess', "");
  }
  function clearProcess() {
    app.$.selector.fire('clearProcess', "");
  }
  function addAll() {
    app.$.selector.fire('addAll', "");
  }
  (function() {
    Polymer({
      is: 'process-selector',

      properties: {

        /**
         * The automata available to walk.
         */
        processes: {
          type: Array
        },
        /**
         * The automata currently on display
         */
        display: {
          type: Array
        },
        hideInterrupts: {
          type: Boolean,
          value: true
        },
        smallScreen: {
          type: Boolean
        },
        _explosionLabel: {
          type: String,
          value: "Explode to process"
        },
        _hasSelection: {
          type: Boolean,
          value: false
        },
        _hasNameSelection: {
          type: Boolean,
          value: false
        },
        _hasProcesses: {
          type: Boolean,
          computed: '_greaterThan(processes.length, 0)'
        },
        _hasNames: {
          type: Boolean,
          computed: '_greaterThan(display.length, 0)'
        },
        /**
         * When dealing with the visualiser, during rendering we want to disable adding new elements.
         *
         */
        locked: {
          type: Boolean,
          value: true
        },

        _initialSelection: {
          type: String,
          computed: 'initialSelection()'
        },
        selectedMenu: {
          type: String
        }
      },

      _combineWithLocked: function(val1, val2) {
        return val1 || !val2;
      },
      _explosionValid: function(val1, val2) {
        let lbl = app.$.selector._explosionLabel;
        return lbl==="Explode to process" && (val1 || !val2);
      },
      /**
       * @returns {!boolean} a > b
       */
      _greaterThan: function(a, b){
        return a > b;
      },
      _onNameSelection: function(e, detail){
        this._hasNameSelection = true;
      },
      _onProcessSelection: function(e, detail){
        this._hasSelection = true;
        var graph = { name:detail.item.dataAutomatonName };
        for(var i in this.display){
          if(this.display[i].id === graph.name){
            graph.graph = this.display[i].graph;
            this.fire('change-process', this.display[i]);
            break;
          }
        }

      },
      initialSelection: function(e, detail){
        return "0";
      },
      getSelected: function() {
        return $("#process-display-selector")[0].selectedItemLabel;
      },
      getSelectedName: function() {
        return $("#process-name-selector")[0].selectedItemLabel;
      }
    });
  })();
</script>
